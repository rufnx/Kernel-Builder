name: QuantumROM - A226B

on:
  workflow_dispatch:
    inputs:
      BRANCH:
        description: "BRANCH SOURCE"
        required: true
        default: "A226b-stable"
      STOCK_DEVICE:
        description: "STOCK_DEVICE_MODEL."
        required: true
        default: "SM-A226B"
      TARGET_DEVICE:
        description: "TARGET_DEVICE_MODEL."
        required: true
        default: "SM-A346B"
      TARGET_DEVICE_CSC:
        description: "TARGET_DEVICE_CSC."
        required: true
        default: "BTB"
      TARGET_DEVICE_IMEI:
        description: "TARGET_DEVICE_IMEI."
        required: true
        default: "351648442869815"
      OUTPUT_FILESYSTEM:
        description: "OUTPUT_FILESYSTEM. e.g erofs / ext4"
        required: true
        default: "erofs"

jobs:
  build:
    environment: Build run by ${{ github.actor }}
    runs-on: ubuntu-24.04
    
    steps:
    - name: Get date
      id: rundate
      run: |
        sudo rm /etc/localtime && sudo ln -s /usr/share/zoneinfo/Asia/Jakarta /etc/localtime
        echo "REPO_DATE=`date`" >> $GITHUB_OUTPUT

    - uses: actions/checkout@v4
      with:
        path: KDIR
        repository: "H33CKER/H3CKED-UI"
        ref: ${{ inputs.BRANCH }}
        show-progress: false
        fetch-depth: 1

    - name: Cleaning junk files
      uses: rokibhasansagar/slimhub_actions@v25.42.5

    - name: Installing required packages.
      run: |
          sudo apt install -y p7zip-full lz4 android-sdk-libsparse-utils python3 python3-pip zipalign unzip e2fsprogs openjdk-17-jdk  >/dev/null 2>&1
          pip3 install liblp tgcrypto pyrogram  >/dev/null 2>&1
          pip3 install git+https://github.com/martinetd/samloader.git  >/dev/null 2>&1
          # Binary
          chmod +x bin/ext4/make_ext4fs
          chmod +x bin/erofs-utils/extract.erofs
          chmod +x bin/erofs-utils/mkfs.erofs
      working-directory: KDIR

    - name: Build Rom
      run: |
        bash scripts/setup_directories.sh FIRMWARE WORK OUT
        sleep 2
        bash sixteen.sh ${{ inputs.STOCK_DEVICE }} ${{ inputs.TARGET_DEVICE }} ${{ inputs.TARGET_DEVICE_CSC }} ${{ inputs.TARGET_DEVICE_IMEI }} ${{ inputs.OUTPUT_FILESYSTEM }}
      working-directory: KDIR

    - name: Splitting files before uploading if need.
      run: |
        echo "GIT_SUPPORT_SIZE=2147483647" >> $GITHUB_OUTPUT
        echo "OUT_DIR=OUT" >> $GITHUB_OUTPUT
        echo "BUILD_TIME=$(date '+%Y-%m-%d %I:%M:%S %p UTC')" >> $GITHUB_ENV
        echo "--- Checking for large files in $OUT_DIR ---"

        for file in "$OUT_DIR"/*; do
          [ -f "$file" ] || continue
          FILE_SIZE=$(stat -c%s "$file")
          if [ "$FILE_SIZE" -gt "$GIT_SUPPORT_SIZE" ]; then
            echo "üì¶ Splitting: $file (Size: $FILE_SIZE bytes)"
            split -b "$GIT_SUPPORT_SIZE" -d -a 3 "$file" "$file.part"
            rm -f "$file"
          fi
        done
      working-directory: KDIR

    - name: Uploading all files to GitHub Release.
      uses: softprops/action-gh-release@v2
      with:
        tag_name: "${{ inputs.STOCK_DEVICE }}-${{ github.run_id }}"
        name: "${{ inputs.TARGET_DEVICE }} Port for ${{ inputs.STOCK_DEVICE }}"
        body: |
          ***Build Information***
          - ‚û°Ô∏è Build For: ${{ github.event.inputs.STOCK_DEVICE }}
          - ‚û°Ô∏è Ported From: ${{ GITHUB.EVENT.INPUTS.TARGET_DEVICE }}
          - ‚è∞Ô∏è Build Time: ${{ env.BUILD_TIME }}
        files: |
          KDIR/OUT/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
